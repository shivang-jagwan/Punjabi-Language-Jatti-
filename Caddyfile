{
	# Keep logs readable; you can increase if needed.
	# debug
}

# Set SITE_ADDRESS in your .env, e.g.
# - SITE_ADDRESS=playground.yourdomain.com
# - SITE_ADDRESS=:80 (local testing)
{$SITE_ADDRESS} {
	encode gzip zstd

	# Demo mode
	# - UI is public
	# - Running code (the /api/* routes) requires either:
	#   - clicking "Demo Mode" (sets jatti_demo=1 cookie), or
	#   - admin basic auth (useful for private/admin access)
	# API key is injected ONLY when allowed, so the browser never needs it.

	(demo_cookie_set) {
		header Set-Cookie "jatti_demo=1; Path=/; Max-Age={$DEMO_COOKIE_MAX_AGE:3600}; SameSite=Lax"
		redir / 302
	}

	(demo_cookie_clear) {
		header Set-Cookie "jatti_demo=; Path=/; Max-Age=0; SameSite=Lax"
		redir / 302
	}

	(app_api_proxy) {
		reverse_proxy jatti-playground:8000 {
			header_up X-API-Key {$JATTI_API_KEY}
		}
	}

	@demo_on path /demo
	handle @demo_on {
		import demo_cookie_set
	}

	@demo_off path /demo/logout
	handle @demo_off {
		import demo_cookie_clear
	}

	# API allowed via demo cookie
	@api_demo {
		path /api/*
		header Cookie *jatti_demo=1*
	}
	handle @api_demo {
		import app_api_proxy
	}

	# API allowed via admin login (Basic Auth)
	@api_admin path /api/*
	handle @api_admin {
		# BASIC_AUTH_HASH must be a Caddy password hash (see docs in PLAYGROUND.md)
		basicauth {
			{$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
		}
		import app_api_proxy
	}

	# Everything else (static UI)
	reverse_proxy jatti-playground:8000
}
